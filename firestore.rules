
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isUser(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }
    
    function isClinic() {
      return isSignedIn() && request.auth.token.clinic == true;
    }
    
    function isPatientOfClinic(clinicId) {
      return isSignedIn() && request.auth.token.clinicId == clinicId;
    }

    // Admins can read and write all data.
    match /{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Clinics collection
    match /clinics/{clinicId} {
      // A clinic can read its own document.
      allow read: if isClinic() && isUser(clinicId);
      
      // A patient can read the document of the clinic they are enrolled in.
      allow read: if isPatientOfClinic(clinicId);
      
      // Only admins can create or update clinic documents (via backend flow).
      allow create, update, delete: if false; 
    }
    
    // Patients sub-collection
    match /clinics/{clinicId}/patients/{patientId} {
      // The owning clinic can read and write its patient data.
      allow read, write: if isClinic() && isUser(clinicId);
      
      // A patient can read their own data.
      allow read: if isUser(patientId);
      
      // Patients cannot update their own official records.
      allow write: if false; 
    }
  }
}
