
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth() && request.auth.token.admin == true;
    }

    function isClinic() {
        return isAuth() && request.auth.token.clinic == true;
    }

    function isUser(uid) {
        return isAuth() && request.auth.uid == uid;
    }
    
    function isPatientOfClinic(clinicId) {
        return isAuth() && request.auth.token.clinicId == clinicId;
    }

    // Rules for the 'clinics' collection
    match /clinics/{clinicId} {
      // Admins can do anything.
      // Clinic users can read their own document.
      // Patients can read the document of the clinic they are assigned to.
      allow read: if isAdmin() || (isClinic() && isUser(clinicId)) || isPatientOfClinic(clinicId);
      
      // Admins can write to any clinic document.
      // Clinic users can update their own document, but not change sensitive fields.
      allow write: if isAdmin();
    }

    // Rules for the 'patients' sub-collection within a clinic
    match /clinics/{clinicId}/patients/{patientId} {
      // Admins can read any patient.
      // The clinic assigned to the patient can read the patient.
      // A patient can read their own record.
      allow read: if isAdmin() || (isClinic() && isUser(clinicId)) || isUser(patientId);

      // Admins and the assigned clinic can create/update patients.
      allow write: if isAdmin() || (isClinic() && isUser(clinicId));
      
      // Admins and assigned clinics can delete patients.
      allow delete: if isAdmin() || (isClinic() && isUser(clinicId));
    }
  }
}
